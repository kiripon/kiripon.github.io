---
title: ARM(aarch64)でスピンロックを書くのに必要だった知識
date: 2021-01-06
draft: true
---

# ARM(aarch64)でスピンロック
最近になって Apple が M1 の載ったマシンを販売するようになったりして ARM がデスクトップ用途でも普及しそうな気配を見せてる。その横でARMを知っている人が並列バグがいろんなアプリで出そう、ということで盛り上がってるっぽい。

これを見て、けっこう前に aarch64 ターゲットで動くスピンロックを書いたのを思い出した。これがすごく勉強になったので、内容をまとめておこうと思ってずっと忘れてた。反省。

結論から言うと、スピンロックを書くのはけっこう難しい。

## 排他制御

複数のスレッドが資源を取り合う時、資源に対する操作中に別のスレッドがその資源にアクセスすることを防ぎたい。マルチスレッドプログラミングにおいて、このようなときに、独占的に資源を利用する権利を与えて他のスレッドから制御させないようにする制御を排他制御と呼ぶ。

排他制御のために使う機構の一つがロックで、そのロックの実装方式の１つがスピンロックだ。あとで触れるけど、スピンロックといっても色んな種類がある。

## ロック

　

## スピンロック

スレッドがロックが獲得可能になるまで, ロックオブジェクトの内部状態をループで監視し続ける方式のロックをスピンロックと呼ぶ。

スピンロックは,コンテキストスイッチが処理のオーバーヘッドになるような, ごく短時間だけブロックされるような場所で使われる.

スピンロックは,ロックの獲得待ちが長時間発生するような場合の排他制御には使用するべきではない. そのような場合の排他制御には mutex を使い, 他のスレッドからの通知を待つべき.

## 排他制御
スピンロックでは, 複数のCPUコアから同じメモリ領域へのアクセスを行う.

## LL/SC 排他命令
Load-Link(LL) 命令と Store-Conditional(SC) 命令の組み合わせで排他処理を行います.

Load-Link 命令はメモリ領域から値の読み込む命令です. LL 命令は, 値の読み込みに加えて, 読み込んだアドレスに対してフラグを設定します.

Store-Conditional はLoad Linkで読み込んだ領域に対して書き込みをする命令です. 書き込み先に変更が加えられていたら書き込みを行わず、そうでなければ書き込みに成功します。

## ARMv8A での排他命令
ARMv8A では, LL/SC に相当する命令として ldrex, strxr がある。

## メモリバリア
レジスタへのアクセスに比べて, メモリへのアクセスはとても遅い. そのため, CPU は命令の先読みをして, 命令の順序を入れ替えて実行する. これをアウト・オブ・オーダー実 行(OoO 実行) という.

デバイスドライバを書く時や並列処理では, メモリへの書き込み順が本質的なことがある. そのようなときには命令の並べ替えを制限する必要がある. この命令の並べ替えの制限のために使う命令をメモリバリアと呼ぶ.

# ARMは弱いメモリモデル 

ARMは弱いメモリモデルを持ちます。

あるコアでメモリ処理を行った後、そのコアのキャッシュの状態が必ずしも他のコアと同期が取れているとは限りません。
(一方で, x86_64 は強いメモリモデルを持ちます。そのため、x86_64 で動作していたプログラムを aarch64 へ移植するとメモリバリアの不足による不具合が顕在化します)

他のコアとメモリ状態の同期をとるにはメモリバリアを適切に配置する必要があります。
