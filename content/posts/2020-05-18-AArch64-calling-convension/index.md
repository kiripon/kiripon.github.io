---
title: "AArch64 の呼び出し規約についてのメモ(WIP)"
date: 2020-05-18T01:12:17+09:00
draft: false
---

https://developer.arm.com/docs/ihi0055/d/procedure-call-standard-for-the-arm-64-bit-architecture

# 関数呼び出し規約

| レジスタ | caller save/callee save |       用途        |
| -------- | ----------------------- | ----------------- |
| sp       | n/a                     | Stack Pointer     |
| r30      | callee save             | Link Register     |
| r29      | callee save             | Frame Pointer     |
| r19..r28 | callee save             |                   |
| r18      |                         | Platform Register |


## スタックポインタ
スタックのアドレスを格納する

## リンクレジスタ
関数のリターンアドレスを保存する. 

## フレームポインタ
関数内のローカル変数などの格納領域アドレスを格納する

## プラットフォームレジスタ
プラットフォーム依存の特殊用途レジスタ            

# 命令

## STP 
レジスタペアストア命令.
ベースレジスタの値と即値のオフセットからアドレスを計算し, 2つの 32bit ワード, または 64bit ダブルワードを計算したアドレスに保存する.

- スタックポインタはどうなる?

# ARM Stack
ヒープはアドレスの大きい方向に伸びていき, 
スタックはアドレスの小さい方向に向けて伸びていく.


# コマンドのメモ

* ldd
依存している動的ライブラリを表示する.

* adrp
PC からの相対ページアドレスの計算を行う. (4kb アライン)

ラベルで指定したアドレスをレジスタに書き込む. 
プログラムカウンタ(PC) に 4GB の範囲のオフセットを加えたアドレスを (4kbを単位とした)ページアドレスに変換して, 指定したレジスタに書き込みます.

`adrp xd, label` と書くので, label のアドレスを直接 xd に転送しているように見えるけど見た目だけで、コンパイル時にアセンブラが PC に対してオフセットを加えるように書き換える.
