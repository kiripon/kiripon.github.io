<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>自由研究帳 - hoge</title>
    <link rel="stylesheet" type="text/css" href="../css/default.css" />
	  <script type="text/javascript" src="//typesquare.com/accessor/script/typesquare.js?3gh7POzSj-0%3D" charset="utf-8"></script>

	  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56315243-1', 'auto');
  ga('send', 'pageview');

</script>

  </head>
  <body>
    <div id="header">
  <div id="logo">
    <a href="../index.html">自由研究帳</a>
  </div>
  <div id="navigation">
    <a href="../index.html">HOME</a>
    <a href="../profile.html">ABOUT</a>
    <a href="../contact.html">CONTACT</a>
    <a href="../archive.html">ARCHIVE</a>
  </div>
</div>

      <main>
          <div id="content">
      <h1>hoge</h1>
      <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
<div class="info">
    Posted on November 16, 2016
    
</div>
<div class="info">
  
  Tags: <a href="../tags/Haskell.html">Haskell</a>
  
</div>

<p>Haskell で最大流問題を初めて書いた.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">{-# LANGUAGE FlexibleContexts #-}</span>
<span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span>
<span class="kw">import </span><span class="dt">Data.List</span>
<span class="kw">import qualified</span> <span class="dt">Data.ByteString</span> <span class="kw">as</span> <span class="dt">BS</span>
<span class="kw">import qualified</span> <span class="dt">Data.ByteString.Char8</span> <span class="kw">as</span> <span class="dt">B8</span>
<span class="kw">import qualified</span> <span class="dt">Data.Vector</span> <span class="kw">as</span> <span class="dt">V</span>
<span class="kw">import qualified</span> <span class="dt">Data.Vector.Mutable</span> <span class="kw">as</span> <span class="dt">MV</span>
<span class="kw">import </span><span class="dt">Control.Monad</span>
<span class="kw">import </span><span class="dt">Data.Maybe</span>
<span class="kw">import </span><span class="dt">Debug.Trace</span>
<span class="kw">import </span><span class="dt">Data.Vector</span> ((!))
<span class="kw">import </span><span class="dt">Control.Applicative</span>
<span class="ot">getInts ::</span> <span class="dt">IO</span> [<span class="dt">Int</span>]
getInts <span class="fu">=</span> unfoldr (B8.readInt <span class="fu">.</span> B8.dropWhile (<span class="fu">==</span><span class="ch">' '</span>)) <span class="fu">&lt;$&gt;</span> BS.getLine
<span class="kw">data</span> <span class="dt">Edge</span> <span class="fu">=</span> <span class="dt">Edge</span> {<span class="ot">to ::</span> <span class="dt">Int</span>,<span class="ot">revIx ::</span> <span class="dt">Int</span>,<span class="ot">capIx ::</span> <span class="dt">Int</span>}
  <span class="kw">deriving</span> (<span class="dt">Show</span>,<span class="dt">Eq</span>)
<span class="kw">type</span> <span class="dt">Graph</span> <span class="fu">=</span> <span class="dt">V.Vector</span> (<span class="dt">V.Vector</span> <span class="dt">Edge</span>)


<span class="ot">printGraph ::</span> <span class="dt">Show</span> a <span class="ot">=&gt;</span> <span class="dt">V.Vector</span> (<span class="dt">V.Vector</span> a) <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
printGraph <span class="fu">=</span> V.mapM_ (\i <span class="ot">-&gt;</span> V.mapM (putStr <span class="fu">.</span> (<span class="ch">' '</span><span class="fu">:</span>) <span class="fu">.</span> show) i <span class="fu">&gt;&gt;</span> putStrLn <span class="st">&quot;&quot;</span>)

<span class="ot">printCap ::</span> <span class="dt">MV.IOVector</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
printCap v <span class="fu">=</span> print <span class="fu">=&lt;&lt;</span> V.freeze v

<span class="ot">getGraph ::</span> <span class="dt">IO</span> (<span class="dt">Graph</span>,<span class="dt">MV.IOVector</span> <span class="dt">Int</span>)
getGraph <span class="fu">=</span> <span class="kw">do</span>
  v<span class="fu">:</span>e<span class="fu">:</span>_ <span class="ot">&lt;-</span> getInts
  cap <span class="ot">&lt;-</span> MV.new (e<span class="fu">*</span><span class="dv">2</span>)
  g <span class="ot">&lt;-</span> MV.replicate v []
  forM_ [<span class="dv">0</span><span class="fu">..</span>e<span class="fu">-</span><span class="dv">1</span>] <span class="fu">$</span> \i <span class="ot">-&gt;</span> <span class="kw">do</span>
    u<span class="fu">:</span>v<span class="fu">:</span>c<span class="fu">:</span>_ <span class="ot">&lt;-</span> getInts
    MV.write cap i c
    MV.write cap (i <span class="fu">+</span> e) <span class="dv">0</span>
    us <span class="ot">&lt;-</span> MV.read g u
    vs <span class="ot">&lt;-</span> MV.read g v
    MV.write g u <span class="fu">$</span> <span class="dt">Edge</span> v (e<span class="fu">+</span>i) i<span class="fu">:</span> us
    MV.write g v <span class="fu">$</span> <span class="dt">Edge</span> u i (e<span class="fu">+</span>i)<span class="fu">:</span> vs
    return ()
  g' <span class="ot">&lt;-</span> V.map (V.fromList <span class="fu">.</span> reverse) <span class="fu">&lt;$&gt;</span> V.freeze g
  return (g', cap)

<span class="ot">main ::</span> <span class="dt">IO</span> ()
main <span class="fu">=</span> <span class="kw">do</span>
  (g,cap) <span class="ot">&lt;-</span> getGraph
  <span class="co">-- printGraph g</span>
  <span class="co">-- printCap cap</span>
  r <span class="ot">&lt;-</span> maxFlow <span class="dv">0</span> (V.length g <span class="fu">-</span> <span class="dv">1</span>) g cap
  print r
  return ()

<span class="ot">untilJustM ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> m (<span class="dt">Maybe</span> b)) <span class="ot">-&gt;</span> <span class="dt">V.Vector</span> a <span class="ot">-&gt;</span> m (<span class="dt">Maybe</span> b)
untilJustM act xs
  <span class="fu">|</span> V.null xs <span class="fu">=</span> return <span class="dt">Nothing</span>
  <span class="fu">|</span> otherwise <span class="fu">=</span> <span class="kw">let</span> v <span class="fu">=</span> V.head xs
                <span class="kw">in</span> <span class="kw">do</span>
      x <span class="ot">&lt;-</span> act v
      <span class="kw">case</span> x <span class="kw">of</span>
        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> untilJustM act (V.tail xs)
        <span class="dt">Just</span> _ <span class="ot">-&gt;</span> return x

<span class="ot">maxFlow ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Graph</span> <span class="ot">-&gt;</span> <span class="dt">MV.IOVector</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Int</span>
maxFlow s t g cap <span class="fu">=</span> loop <span class="dv">0</span>
  <span class="kw">where</span>
    loop f <span class="fu">=</span> <span class="kw">do</span>
      used <span class="ot">&lt;-</span> MV.replicate (V.length g) <span class="dt">False</span>
      df <span class="ot">&lt;-</span> dfs maxBound s t g cap used
      <span class="kw">if</span> df <span class="fu">==</span> <span class="dv">0</span>
        <span class="kw">then</span> return f
        <span class="kw">else</span> loop (f <span class="fu">+</span> df)

<span class="ot">dfs ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Graph</span>
  <span class="ot">-&gt;</span> <span class="dt">MV.IOVector</span> <span class="dt">Int</span>
  <span class="ot">-&gt;</span> <span class="dt">MV.IOVector</span> <span class="dt">Bool</span>
  <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Int</span>
dfs f v t g cap used
  <span class="co">-- | traceShow v False = undefined</span>
  <span class="fu">|</span> v <span class="fu">==</span> t <span class="fu">=</span> return f
  <span class="fu">|</span> otherwise <span class="fu">=</span> <span class="kw">do</span>
      MV.write used v <span class="dt">True</span>
      fromMaybe <span class="dv">0</span> <span class="fu">&lt;$&gt;</span> untilJustM act (g <span class="fu">!</span> v)
  <span class="kw">where</span>
<span class="ot">    act ::</span> <span class="dt">Edge</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">Int</span>)
    act e<span class="fu">@</span><span class="dt">Edge</span> {to <span class="fu">=</span> to,capIx <span class="fu">=</span> ci, revIx <span class="fu">=</span> ri} <span class="fu">=</span> <span class="kw">do</span>
      c <span class="ot">&lt;-</span> MV.read cap ci
      isUsed <span class="ot">&lt;-</span> MV.read used to
      <span class="kw">if</span> c <span class="fu">&gt;</span> <span class="dv">0</span> <span class="fu">&amp;&amp;</span> not isUsed
      <span class="kw">then</span> <span class="kw">do</span>
        d <span class="ot">&lt;-</span> dfs (min f c) to t g cap used
        <span class="kw">if</span> d <span class="fu">&gt;</span> <span class="dv">0</span>
        <span class="kw">then</span> <span class="kw">do</span>
          modifyCap cap e d
          return (<span class="dt">Just</span> d)
        <span class="kw">else</span> return <span class="dt">Nothing</span>
      <span class="kw">else</span> return <span class="dt">Nothing</span>

<span class="ot">modifyCap ::</span> <span class="dt">MV.IOVector</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Edge</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
modifyCap cap <span class="dt">Edge</span> {capIx <span class="fu">=</span> ci, revIx <span class="fu">=</span> ri} d
  <span class="fu">=</span> <span class="kw">do</span>
  cv <span class="ot">&lt;-</span> MV.read cap ci
  cr <span class="ot">&lt;-</span> MV.read cap ri
  MV.write cap ci <span class="fu">$</span> cv <span class="fu">-</span> d
  MV.write cap ri <span class="fu">$</span> cr <span class="fu">+</span> d</code></pre></div>

<br>

<div id="disqus_thread"><div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  // required: replace example with your forum shortname
  var disqus_shortname = 'kiripon';
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  // required: replace example with your forum shortname
  var disqus_shortname = 'kiripon';
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>

          </div>
      </main>
    <div id="footer">
  <p>Copyright(C) 2013-2016, Kiripon</p>
  <p>Source code font is <a href="https://github.com/i-tu/Hasklig">Hasklig</a>,
    distributed under <a href="../texts/LICENSE.txt">OFL</a>.</p>
	<p>Site generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a></p>
</div>
<script src="https://use.typekit.net/qtn2ufl.js"></script>
<script>try{Typekit.load({ async: true });}catch(e){}</script>

  </body>
</html>
